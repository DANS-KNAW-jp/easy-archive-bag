#
# Copyright (C) 2015 DANS - Data Archiving and Networked Services (info@dans.knaw.nl)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

- hosts: "test"
  become: yes
  vars:
    local_test_vm_install_httpd: no
  roles:
    - dans.local-test-vm-base
    - dans.local-yum-repo
    - dans.postgresql

- hosts: "test"
  become: yes
  tasks:
    - name: Installing packages
        yum:
          name: "{{ item }}"
          state: latest
        with_items:
          - dans.knaw.nl-easy-archive-bag
          - dans.knaw.nl-easy-bag-store
          - dans.knaw.nl-easy-bag-index

  - name: Configure application (archive-bag application.properties)
    replace:
      dest: '/etc/opt/dans.knaw.nl/easy-archive-bag/application.properties'
      regexp: '^{{ item.key }}=.*$'
      replace: '{{ item.key }}={{ item.value }}'
    with_items:
      - { key: 'default.storage-service-url', value: 'http://localhost:20110/stores/default/' }

  - name: Configure application (bag-store application.properties)
    replace:
      dest: '/etc/opt/dans.knaw.nl/easy-bag-store/application.properties'
      regexp: '^{{ item.key }}=.*$'
      replace: '{{ item.key }}={{ item.value }}'
    with_items:
      - { key: 'daemon.external-base-uri', value: 'http://test.dans.knaw.nl/' }

  - name: Configure application (bag-index application.properties)
    replace:
      dest: '/etc/opt/dans.knaw.nl/easy-bag-index/application.properties'
      regexp: '^{{ item.key }}=.*$'
      replace: '{{ item.key }}={{ item.value }}'
    with_items:
      - { key: 'bag-index.bag-store.base-dirs', value: '/srv/dans.knaw.nl/bag-store' }
# TODO uncomment all of this when the bag-index has removed creating the database from the rpm
#      - { key: 'bag-index.database.password',  value: 'easy_bag_index' }
#
#  - name: Check if database exists
#    command: sudo -u postgres psql -c "\c easy_bag_index" easy_bag_index
#    ignore_errors: yes
#    register: db_created
#
#  - name: Create owner user in PostGreSQL
#    command: "sudo -u postgres psql -c \"CREATE ROLE easy_bag_index WITH LOGIN PASSWORD 'easy_bag_index'\""
#    args:
#      chdir: "/tmp"
#    ignore_errors: yes
#    when: db_created.rc != 0
#
#  - name: Create the database
#    command: "sudo -u postgres psql -c \"CREATE DATABASE easy_bag_index WITH OWNER = easy_bag_index ENCODING = 'UTF8' CONNECTION LIMIT = -1\""
#    args:
#      chdir: "/tmp"
#    when: db_created.rc != 0
#
#  - name: Create the tables
#    command: "sudo -u postgres psql -d easy_bag_index -f /opt/dans.knaw.nl/easy-bag-index/bin/db-tables.sql"
#    args:
#      chdir: "/tmp"
#    when: db_created.rc != 0

  - service:
      name: "{{ item }}"
      state: restarted
      enabled: yes
    with_items:
      - easy-bag-store
      - easy-bag-index
